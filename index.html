<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToscripT - Screenwriting</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- ALL CSS IS NOW INSIDE THIS STYLE TAG -->
    <style>
        /* =================================================================
           --- UNIVERSAL THEME & FONT SETUP ---
           ================================================================= */
        :root {
            --primary-color: #3b82f6;
            --background-color: #111827;
            --surface-color: #1f2937;
            --text-color: #f3f4f6;
            --muted-text-color: #9ca3af;
            --border-color: #374151;
            --danger-color: #ef4444;
            --success-color: #22c55e;
        }
        body {
            background-color: var(--background-color); color: var(--text-color); font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; margin: 0;
        }
        body.fullscreen-active #main-header { display: none; }
        body.fullscreen-active .main-content { height: 100vh; }

        /* =================================================================
           --- HEADER & MAIN LAYOUT ---
           ================================================================= */
        .page-header { display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; height: 55px; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: relative; z-index: 30; }
        .page-header h1 { font-family: 'Courier Prime', monospace; font-size: 1.8rem; font-weight: 700; color: white; }
        .icon-btn { background: none; border: none; color: var(--muted-text-color); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 50%; line-height: 1; }
        .icon-btn:hover { background-color: var(--background-color); color: white; }
        .main-content { flex-grow: 1; display: flex; overflow: hidden; height: calc(100vh - 55px); }
        .view { width: 100%; height: 100%; display: none; flex-direction: column; }
        .view.active { display: flex; }

        /* =================================================================
           --- SIDE MENUS & PANELS ---
           ================================================================= */
        .side-menu { position: absolute; top: 55px; left: 0; width: 250px; background-color: var(--surface-color); box-shadow: 4px 0 15px rgba(0,0,0,0.3); z-index: 40; transform: translateX(-100%); transition: transform 0.3s ease-in-out; border-bottom-right-radius: 8px; padding: 1rem; }
        .side-menu.open { transform: translateX(0); }
        .side-menu nav a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text-color); text-decoration: none; border-radius: 6px; margin-bottom: 0.25rem; }
        .side-menu nav a:hover { background-color: var(--background-color); }
        .side-menu .flex-between { justify-content: space-between; }
        .indicator { width: 1rem; height: 1rem; border-radius: 50%; }
        .indicator.off { background-color: var(--danger-color); }
        .indicator.on { background-color: var(--success-color); }
        .dropdown-container .dropdown-toggle::after { content: ' ▸'; }
        .dropdown-container.open .dropdown-toggle::after { content: ' ▾'; }
        .dropdown-content { display: none; padding-left: 1.5rem; margin-top: 0.25rem; }
        .dropdown-content a { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .dropdown-container.open .dropdown-content { display: block; }
        .pro-feature { color: #f59e0b !important; font-weight: bold; }
        .side-panel { position: absolute; top: 0; right: 0; width: 300px; max-width: 80%; height: 100%; background-color: var(--surface-color); box-shadow: -4px 0 15px rgba(0,0,0,0.3); z-index: 40; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .side-panel.open { transform: translateX(0); }
        .panel-header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { margin: 0; font-size: 1.25rem; }
        .panel-section { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .panel-section h4 { margin: 0 0 0.5rem 0; }
        .panel-section select, .panel-section input { width: 100%; padding: 0.5rem; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); margin-top: 0.5rem; }
        .panel-subtext { margin: 0.5rem 0; font-size: 0.8rem; color: var(--muted-text-color); }
        #scene-list { flex-grow: 1; overflow-y: auto; padding: 0.5rem; list-style: none; margin: 0; }
        #scene-list li { padding: 0.75rem 1rem; border-radius: 6px; cursor: grab; margin-bottom: 0.25rem; border: 1px solid transparent; background-color: var(--background-color); }
        #scene-list li:hover { border-color: var(--border-color); }
        .dragging { opacity: 0.5; background: var(--primary-color); }

        /* =================================================================
           --- EDITOR, PREVIEW & CARD VIEW ---
           ================================================================= */
        #main-toolbar { background-color: var(--background-color); padding: 0.5rem; display: flex; justify-content: center; gap: 0.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .toolbar-btn, .action-btn { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .toolbar-btn:hover, .action-btn:hover { background-color: var(--primary-color); border-color: var(--primary-color); }
        .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: var(--surface-color); }
        .editor-area { flex-grow: 1; padding: 0.5rem; display: flex; gap: 0.5rem; overflow: hidden; }
        #fountain-input { flex-grow: 1; height: 100%; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; color: var(--text-color); resize: none; font-family: 'Courier Prime', monospace; font-size: 16px; line-height: 1.6; }
        #fountain-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        #fountain-input.placeholder { color: var(--muted-text-color); font-style: italic; }
        #desktop-side-toolbar { display: flex; flex-direction: column; gap: 0.5rem; }
        .bottom-bar { padding: 0.5rem; flex-shrink: 0; }
        .main-action-btn { width: 100%; background-color: var(--primary-color); color: white; font-weight: bold; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1.1rem; border: none; cursor: pointer; }
        .main-action-btn.secondary { background-color: var(--surface-color); border: 1px solid var(--border-color); }
        #mobile-bottom-toolbar { display: none; }
        .preview-area { flex-grow: 1; padding: 0.5rem; overflow: hidden; background-color: var(--background-color); }
        #screenplay-output { font-family: 'Courier Prime', monospace; background-color: white; color: black; padding: 2rem 1.5rem; height: 100%; overflow-y: auto; border-radius: 8px; max-width: 8.5in; margin: 0 auto; }
        .title-page { text-align: center; margin-bottom: 2rem; } .scene-heading { font-weight: bold; text-transform: uppercase; margin-top: 1.5rem; margin-bottom: 1rem; } .action { margin-bottom: 1rem; } .character { text-transform: uppercase; margin-left: 37%; font-weight: bold; margin-top: 1.5rem; } .dialogue { margin-left: 25%; margin-right: 15%; } .parenthetical { margin-left: 30%; margin-right: 25%; } .transition { text-align: right; text-transform: uppercase; font-weight: bold; margin-top: 1.5rem; }
        #card-view { overflow-y: auto; padding: 1rem; }
        #card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .scene-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; display: flex; flex-direction: column; }
        .card-header { font-family: 'Courier Prime', monospace; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
        .card-body { flex-grow: 1; font-family: 'Courier Prime', monospace; font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; margin-bottom: 1rem; max-height: 200px; overflow-y: auto; }
        .card-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* =================================================================
           --- MODALS ---
           ================================================================= */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal.open { display: flex; }
        .modal-content { background-color: var(--surface-color); border-radius: 8px; padding: 1.5rem; max-width: 500px; width: 100%; position: relative; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; } .modal-header h2 { margin: 0; }
        .modal-body .form-group { margin-bottom: 1rem; } .modal-body label { display: block; margin-bottom: 0.5rem; }
        .modal-body input, .modal-body textarea { width: 100%; padding: 0.75rem; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); }
        .modal-footer { margin-top: 1.5rem; text-align: right; }

        /* =================================================================
           --- RESPONSIVENESS & SCROLLBARS ---
           ================================================================= */
        @media (max-width: 768px) {
            #desktop-side-toolbar { display: none; }
            #mobile-bottom-toolbar { display: flex; justify-content: space-around; gap: 0.5rem; margin-bottom: 0.5rem; }
            .editor-area, .preview-area { padding: 0.25rem; }
            #fountain-input { padding: 1rem; }
            .page-header h1 { font-size: 1.5rem; }
        }
        textarea::-webkit-scrollbar, #screenplay-output::-webkit-scrollbar, #scene-list::-webkit-scrollbar, .card-body::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, #screenplay-output::-webkit-scrollbar-track, #scene-list::-webkit-scrollbar-track, .card-body::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb, #screenplay-output::-webkit-scrollbar-thumb, #scene-list::-webkit-scrollbar-thumb, .card-body::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 20px; }
    </style>

    <!-- Third-Party JS Libraries from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fountain-js/index.min.js"></script>
</head>
<body>
    <header id="main-header" class="page-header">
        <button id="hamburger-btn" class="icon-btn" title="Menu">
            <i class="fas fa-bars"></i>
        </button>
        <h1>ToscripT</h1>
        <div class="header-right">
            <button id="scene-navigator-btn" class="icon-btn" title="Scene Navigator & Filters">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
    </header>

    <div id="menu-panel" class="side-menu">
        <nav>
            <a href="#" id="new-btn"><i class="fas fa-file"></i> New Project</a>
            <a href="#" id="open-btn"><i class="fas fa-folder-open"></i> Open...</a>
            <a href="#" id="project-info-btn"><i class="fas fa-info-circle"></i> Project Info</a>
            <a href="#" id="title-page-btn"><i class="fas fa-book-open"></i> Title Page</a>
            <div class="dropdown-container">
                <a href="#" id="save-menu-btn" class="dropdown-toggle"><i class="fas fa-save"></i> Save As...</a>
                <div id="save-menu" class="dropdown-content">
                    <a href="#" id="save-fountain-btn">.fountain (Text)</a>
                    <a href="#" id="save-pdf-btn">.pdf (Formatted)</a>
                    <a href="#" id="save-filmproj-btn" class="pro-feature">.filmproj (for To Make/To Sched)</a>
                </div>
            </div>
             <a href="#" id="auto-save-btn" class="flex-between">
                <span><i class="fas fa-sync-alt"></i> Auto-Save</span>
                <span id="auto-save-indicator" class="indicator off"></span>
            </a>
            <a href="#" id="share-btn"><i class="fas fa-share-alt"></i> Share...</a>
            <a href="#" id="scene-no-btn" class="flex-between">
                <span><i class="fas fa-hashtag"></i> Scene Nos.</span>
                <span id="scene-no-indicator" class="indicator on"></span>
            </a>
            <a href="#" id="info-btn"><i class="fas fa-question-circle"></i> Info & Help</a>
            <a href="#" id="about-btn"><i class="fas fa-user-friends"></i> About</a>
        </nav>
    </div>

    <main class="main-content">
        <div id="write-view" class="view active">
            <div id="main-toolbar">
                <button id="card-view-btn" class="toolbar-btn" title="Card View"><i class="fas fa-grip-vertical"></i></button>
                <button id="zoom-in-btn" class="toolbar-btn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                <button id="zoom-out-btn" class="toolbar-btn" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                <button id="fullscreen-btn-main" class="toolbar-btn" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
            </div>
            <div class="editor-area">
                <textarea id="fountain-input"></textarea>
                <div id="desktop-side-toolbar">
                    <button class="action-btn" data-action="scene" title="Cycle Scene (INT./EXT.)">I/E</button>
                    <button class="action-btn" data-action="time" title="Cycle Time of Day (DAY/NIGHT)">D/N</button>
                    <button class="action-btn" data-action="caps" title="Toggle Case (UPPER/lower)">Aa</button>
                    <button class="action-btn" data-action="parens" title="Add Parentheses">()</button>
                    <button class="action-btn" data-action="transition" title="Cycle Transition">TO:</button>
                    <button id="undo-btn" class="toolbar-btn" disabled title="Undo"><i class="fas fa-undo"></i></button>
                    <button id="redo-btn" class="toolbar-btn" disabled title="Redo"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            <div class="bottom-bar">
                <div id="mobile-bottom-toolbar">
                    <button class="action-btn" data-action="caps">Aa</button>
                    <button class="action-btn" data-action="parens">()</button>
                    <button class="action-btn" data-action="scene">I/E</button>
                    <button class="action-btn" data-action="time">D/N</button>
                    <button class="action-btn" data-action="transition">TO:</button>
                    <button id="undo-btn-mobile" class="toolbar-btn" disabled><i class="fas fa-undo"></i></button>
                    <button id="redo-btn-mobile" class="toolbar-btn" disabled><i class="fas fa-redo"></i></button>
                </div>
                <button id="show-script-btn" class="main-action-btn">TO SCRIPT</button>
            </div>
        </div>
        <div id="script-view" class="view">
            <div class="preview-area">
                <div id="screenplay-output"></div>
            </div>
            <div class="bottom-bar">
                <button id="show-write-btn" class="main-action-btn secondary">TO WRITE</button>
            </div>
        </div>
        <div id="card-view" class="view">
             <div id="card-container"></div>
             <div class="bottom-bar">
                <button id="show-write-btn-from-card" class="main-action-btn secondary">TO WRITE</button>
            </div>
        </div>
    </main>

    <div id="scene-navigator-panel" class="side-panel">
        <div class="panel-header">
            <h2>Navigator & Filters</h2>
            <button id="close-navigator-btn" class="icon-btn">&times;</button>
        </div>
        <div class="panel-section">
            <h4>Filter Script</h4>
            <select id="filter-category-select">
                <option value="all">Show All Scenes</option>
                <option value="sceneSetting">Scene Setting</option>
                <option value="sceneType">INT./EXT.</option>
                <option value="cast">Character</option>
            </select>
            <input type="text" id="filter-value-input" placeholder="Type to filter..." style="display: none;">
        </div>
        <div class="panel-section">
            <h4>Reorder Scenes</h4>
            <p class="panel-subtext">Drag to reorder scenes</p>
            <ul id="scene-list"></ul>
        </div>
    </div>
    
    <div id="info-modal" class="modal"></div>
    <div id="about-modal" class="modal"></div>
    <div id="title-page-modal" class="modal"></div>
    <div id="project-info-modal" class="modal"></div>
    
    <input type="file" id="file-input" style="display: none;" accept=".fountain,.txt,.filmproj">

    <script>
        // --- THIS IS THE FIX ---
        // By wrapping the entire script in a DOMContentLoaded listener,
        // we guarantee that all HTML elements and libraries are ready before the script runs.
        document.addEventListener('DOMContentLoaded', () => {
            console.log("ToscripT Initializing with Universal Project Logic...");

            let projectData = {};
            let fontSize = 16;
            let autoSaveInterval = null;
            let showSceneNumbers = true;
            let currentView = 'write';

            const fountainInput = document.getElementById('fountain-input');
            const screenplayOutput = document.getElementById('screenplay-output');
            const menuPanel = document.getElementById('menu-panel');
            const sceneNavigatorPanel = document.getElementById('scene-navigator-panel');
            const writeView = document.getElementById('write-view');
            const scriptView = document.getElementById('script-view');
            const cardView = document.getElementById('card-view');
            const cardContainer = document.getElementById('card-container');
            const sceneList = document.getElementById('scene-list');
            const filterCategorySelect = document.getElementById('filter-category-select');
            const filterValueInput = document.getElementById('filter-value-input');
            const fileInput = document.getElementById('file-input');

            const placeholderText = `TITLE: THE CRIMSON DOSSIER\nAUTHOR: YOUR NAME\n\nINT. DETECTIVE'S OFFICE - NIGHT\n\nThe office is a mess of old files. DETECTIVE VIKRAM (40s, tired) stares at a cold cup of coffee.\n\nA mysterious client, MAYA (30s, elegant), enters from the shadows.\n\nMAYA\n(softly)\nAre you the one they call the Ghost of Bangalore?\n\nVIKRAM\nThat depends on who's asking.\n\nFADE OUT.`;

            const history = {
                stack: [""], currentIndex: 0,
                add(value) { if (value === placeholderText || value === this.stack[this.currentIndex]) return; this.stack = this.stack.slice(0, this.currentIndex + 1); this.stack.push(value); this.currentIndex++; this.updateButtons(); },
                undo() { if (this.canUndo()) { this.currentIndex--; this.updateInput(); } },
                redo() { if (this.canRedo()) { this.currentIndex++; this.updateInput(); } },
                canUndo() { return this.currentIndex > 0; },
                canRedo() { return this.currentIndex < this.stack.length - 1; },
                updateInput() { fountainInput.value = this.stack[this.currentIndex] || ''; if (fountainInput.value === '') setPlaceholder(); else clearPlaceholder(); this.updateButtons(); },
                updateButtons() { document.querySelectorAll('#undo-btn, #undo-btn-mobile').forEach(btn => btn.disabled = !this.canUndo()); document.querySelectorAll('#redo-btn, #redo-btn-mobile').forEach(btn => btn.disabled = !this.canRedo()); }
            };

            function setPlaceholder() { if (fountainInput.value === '') { fountainInput.value = placeholderText; fountainInput.classList.add('placeholder'); } }
            function clearPlaceholder() { if (fountainInput.classList.contains('placeholder')) { fountainInput.value = ''; fountainInput.classList.remove('placeholder'); } }

            function setupEventListeners() {
                const safeAddListener = (id, event, handler) => { const el = document.getElementById(id); if(el) el.addEventListener(event, handler); };
                
                fountainInput.addEventListener('focus', clearPlaceholder);
                fountainInput.addEventListener('blur', setPlaceholder);
                fountainInput.addEventListener('input', () => { history.add(fountainInput.value); saveProjectData(); });
                
                safeAddListener('new-btn', 'click', () => { if (confirm('Are you sure? Unsaved changes will be lost.')) { fountainInput.value = ''; projectData = createNewProjectObject(); history.stack = [""]; history.currentIndex = 0; history.updateButtons(); saveProjectData(); setPlaceholder(); } });
                safeAddListener('open-btn', 'click', () => fileInput.click());
                fileInput.addEventListener('change', openFountainFile);
                safeAddListener('save-menu-btn', 'click', (e) => { e.preventDefault(); e.currentTarget.parentElement.classList.toggle('open'); });
                safeAddListener('save-fountain-btn', 'click', saveAsFountain);
                safeAddListener('save-pdf-btn', 'click', saveAsPdfWithUnicode);
                safeAddListener('save-filmproj-btn', 'click', saveAsFilmProj);
                safeAddListener('share-btn', 'click', shareScript);
                safeAddListener('info-btn', 'click', () => document.getElementById('info-modal').classList.add('open'));
                safeAddListener('about-btn', 'click', () => document.getElementById('about-modal').classList.add('open'));
                safeAddListener('project-info-btn', 'click', openProjectInfoModal);
                safeAddListener('title-page-btn', 'click', openTitlePageModal);
                safeAddListener('show-script-btn', 'click', () => switchView('script'));
                safeAddListener('show-write-btn', 'click', () => switchView('write'));
                safeAddListener('show-write-btn-from-card', 'click', () => switchView('write'));
                safeAddListener('card-view-btn', 'click', () => switchView('card'));
                safeAddListener('hamburger-btn', 'click', () => menuPanel.classList.toggle('open'));
                document.addEventListener('click', (e) => { if (menuPanel.classList.contains('open') && !menuPanel.contains(e.target) && e.target.id !== 'hamburger-btn' && !e.target.closest('#hamburger-btn')) { menuPanel.classList.remove('open'); } });
                safeAddListener('zoom-in-btn', 'click', () => { fontSize = Math.min(32, fontSize + 2); fountainInput.style.fontSize = `${fontSize}px`; });
                safeAddListener('zoom-out-btn', 'click', () => { fontSize = Math.max(10, fontSize - 2); fountainInput.style.fontSize = `${fontSize}px`; });
                safeAddListener('scene-no-btn', 'click', toggleSceneNumbers);
                safeAddListener('scene-navigator-btn', 'click', () => { updateSceneNavigator(); sceneNavigatorPanel.classList.add('open'); });
                safeAddListener('close-navigator-btn', 'click', () => sceneNavigatorPanel.classList.remove('open'));
                safeAddListener('auto-save-btn', 'click', toggleAutoSave);
                document.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', handleActionBtn));
                document.querySelectorAll('#undo-btn, #undo-btn-mobile').forEach(btn => btn.addEventListener('click', () => history.undo()));
                document.querySelectorAll('#redo-btn, #redo-btn-mobile').forEach(btn => btn.addEventListener('click', () => history.redo()));
                safeAddListener('fullscreen-btn-main', 'click', () => { document.body.classList.toggle('fullscreen-active'); if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } });
                filterCategorySelect.addEventListener('change', handleFilterChange);
                filterValueInput.addEventListener('input', applyFilter);

                document.body.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    if (e.target.classList.contains('modal-close-btn') || e.target === modal) {
                       if(modal) modal.classList.remove('open');
                    }
                    if (e.target.id === 'save-title-btn') saveTitlePage();
                    if (e.target.id === 'save-project-info-btn') handleSaveProjectInfo();
                    
                    const editCardBtn = e.target.closest('.edit-card-btn');
                    if(editCardBtn) editSceneFromCard(editCardBtn.closest('.scene-card').dataset.sceneId);
                    
                    const shareCardBtn = e.target.closest('.share-card-btn');
                    if(shareCardBtn) shareSceneCardAsImage(shareCardBtn.closest('.scene-card'));
                });
            }

            function createNewProjectObject() { return { fileVersion: "1.0", projectInfo: { projectName: "Untitled", directorName: "", prodName: "Author", currency: "USD", scriptContent: "" }, scenes: [], appSpecificData: { toMake: { panelItems: [] }, toSched: { panelItems: [] } } }; }
            function saveProjectData() { if(projectData && projectData.projectInfo) { projectData.projectInfo.scriptContent = fountainInput.value; } localStorage.setItem('universalFilmProject_ToScript', JSON.stringify(projectData)); }
            function loadProjectData() {
                const savedData = localStorage.getItem('universalFilmProject_ToScript');
                projectData = savedData ? JSON.parse(savedData) : createNewProjectObject();
                fountainInput.value = projectData.projectInfo.scriptContent || '';
                updateSceneNoIndicator();
            }
            function openFountainFile(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { fountainInput.value = e.target.result; history.add(fountainInput.value); saveProjectData(); }; reader.readAsText(file); }
            function saveAsFountain() { const text = getFilteredScriptText(); const blob = new Blob([text], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${projectData.projectInfo.projectName}.fountain`; a.click(); URL.revokeObjectURL(url); }

            function saveAsFilmProj() {
                projectData.projectInfo.scriptContent = fountainInput.value;
                const universalProject = parseScriptToUniversalFormat(fountainInput.value, projectData.projectInfo);
                const dataStr = JSON.stringify(universalProject, null, 2);
                const blob = new Blob([dataStr], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `${projectData.projectInfo.projectName}.filmproj`; a.click(); URL.revokeObjectURL(url);
                alert('.filmproj file saved! You can now open this in To Make or To Sched.');
            }
            
            function parseScriptToUniversalFormat(scriptText, projectInfo) {
                const output = fountain.parse(scriptText, true);
                const universalData = {
                    fileVersion: "1.0", projectInfo: { ...projectInfo, scriptContent: scriptText }, scenes: [],
                    appSpecificData: { toMake: { panelItems: [] }, toSched: { panelItems: [] } }
                };
                let currentScene = null;
                let sceneCounter = 0;
                output.tokens.forEach(token => {
                    if (token.type === 'scene_heading') {
                        if (currentScene) universalData.scenes.push(currentScene);
                        sceneCounter++;
                        const headingText = token.text.toUpperCase(); const headingParts = headingText.split(' - ');
                        const typeAndSetting = headingParts[0].trim(); const time = (headingParts[1] || 'DAY').trim();
                        let sceneType = "INT.";
                        if (typeAndSetting.startsWith("EXT.")) sceneType = "EXT.";
                        if (typeAndSetting.startsWith("INT./EXT.")) sceneType = "INT./EXT.";
                        const sceneSetting = typeAndSetting.replace(/^(INT\.?\/EXT\.?|INT\.|EXT\.)\s*/, '').trim();
                        currentScene = {
                            sceneId: `s_${Date.now()}_${sceneCounter}`, sceneNumber: token.scene_number || sceneCounter.toString(),
                            sceneType: sceneType, sceneSetting: sceneSetting, dayNight: time, description: "",
                            breakdownData: { cast: [] }, budgetingData: {}, schedulingData: {}
                        };
                    } else if (currentScene) {
                        if (token.type === 'action') { currentScene.description += (currentScene.description ? "\n" : "") + token.text; } 
                        else if (token.type === 'character') {
                            const characterName = token.text.replace(/\s*\(.*\)\s*$/, '').trim();
                            if (characterName && !currentScene.breakdownData.cast.some(c => c.name === characterName)) {
                                currentScene.breakdownData.cast.push({ id: Date.now() + Math.random(), name: characterName, cost: 0 });
                            }
                        }
                    }
                });
                if (currentScene) universalData.scenes.push(currentScene);
                const defaultSequence = { type: 'sequence', id: Date.now(), name: "Main Sequence", sceneIds: universalData.scenes.map(s => s.sceneId) };
                universalData.appSpecificData.toMake.panelItems.push(JSON.parse(JSON.stringify(defaultSequence)));
                universalData.appSpecificData.toSched.panelItems.push(JSON.parse(JSON.stringify(defaultSequence)));
                return universalData;
            }

            async function saveAsPdfWithUnicode() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); try { const fontUrl = 'https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/v27/o-0IIpQlx3QUlC5A4PNr5TRA.ttf'; const fontResponse = await fetch(fontUrl); if (!fontResponse.ok) throw new Error("Could not fetch font file."); const font = await fontResponse.arrayBuffer(); const fontBase64 = btoa(new Uint8Array(font).reduce((data, byte) => data + String.fromCharCode(byte), '')); doc.addFileToVFS('NotoSans-Regular.ttf', fontBase64); doc.addFont('NotoSans-Regular.ttf', 'NotoSans', 'normal'); doc.setFont('NotoSans'); } catch (e) { console.error("Font loading failed, falling back to default font.", e); } const output = fountain.parse(getFilteredScriptText(), true); screenplayOutput.innerHTML = `<div class="title-page"><h1>${projectData.projectInfo.projectName}</h1><p>${projectData.projectInfo.prodName}</p></div>${output.html.body}`; await doc.html(screenplayOutput, { callback: (doc) => { doc.save(`${projectData.projectInfo.projectName}.pdf`); }, x: 10, y: 10, width: 190, windowWidth: 800 }); }
            function switchView(view) { currentView = view; [writeView, scriptView, cardView].forEach(v => v.classList.remove('active')); if (view === 'script') { renderScript(); scriptView.classList.add('active'); } else if (view === 'card') { renderCardView(); cardView.classList.add('active'); } else { writeView.classList.add('active'); } }
            function renderScript() { const text = getFilteredScriptText(); const output = fountain.parse(text, true); const titleHtml = `<h1>${projectData.projectInfo.projectName || 'Untitled'}</h1><p class="author">by ${projectData.projectInfo.prodName || 'Author'}</p>`; let scriptHtml = output.html.body; if (showSceneNumbers) { let sceneCount = 0; const sceneHeadings = output.tokens.filter(t => t.type === 'scene_heading'); scriptHtml = scriptHtml.replace(/<h3/g, () => { if (sceneHeadings[sceneCount]) { const sceneNum = sceneHeadings[sceneCount].scene_number; sceneCount++; return `<h3>${sceneNum}. `; } return `<h3>`; }); } screenplayOutput.innerHTML = `<div class="title-page">${titleHtml}</div>${scriptHtml}`; }
            
            function renderCardView() {
                const scenes = parseScriptToUniversalFormat(getFilteredScriptText(), projectData.projectInfo).scenes;
                if(scenes.length === 0) { cardContainer.innerHTML = `<p style="text-align: center; color: var(--muted-text-color); padding: 2rem;">No scenes found to display as cards.</p>`; return; }
                cardContainer.innerHTML = scenes.map(scene => `
                    <div class="scene-card" data-scene-id="${scene.sceneId}" data-scene-number="${scene.sceneNumber}">
                        <div class="card-header">#${scene.sceneNumber} ${scene.sceneType} ${scene.sceneSetting} - ${scene.dayNight}</div>
                        <div class="card-body">${scene.description}</div>
                        <div class="card-actions">
                            <button class="icon-btn edit-card-btn" title="Edit Scene"><i class="fas fa-pencil-alt"></i></button>
                            <button class="icon-btn share-card-btn" title="Share as Image"><i class="fas fa-share-alt"></i></button>
                        </div>
                    </div>
                `).join('');
            }
            
            function handleActionBtn(e) { const action = e.currentTarget.dataset.action; const { selectionStart, selectionEnd, value } = fountainInput; const selectedText = value.substring(selectionStart, selectionEnd); let newText; switch(action) { case 'caps': const lineStart = value.lastIndexOf('\n', selectionStart -1) + 1; const currentLine = value.substring(lineStart, selectionStart); newText = (currentLine === currentLine.toUpperCase()) ? currentLine.toLowerCase() : currentLine.toUpperCase(); fountainInput.setRangeText(newText, lineStart, selectionStart); break; case 'parens': document.execCommand('insertText', false, `(${selectedText})`); break; case 'scene': cycleText(['INT. ', 'EXT. ', 'INT./EXT. ']); break; case 'time': cycleText([' - DAY', ' - NIGHT']); break; case 'transition': cycleText(['CUT TO:', 'DISSOLVE TO:', 'FADE OUT.', 'FADE IN:']); break; } history.add(fountainInput.value); }
            function cycleText(options) {
                const { value, selectionStart } = fountainInput;
                const lineStart = value.lastIndexOf('\n', selectionStart - 1) + 1;
                const lineEnd = value.indexOf('\n', selectionStart);
                const currentLine = value.substring(lineStart, lineEnd > -1 ? lineEnd : value.length);
                let currentIndex = -1;
                for(let i = 0; i < options.length; i++) { if (currentLine.includes(options[i])) { currentIndex = i; break; } }
                const nextOption = options[(currentIndex + 1) % options.length];
                if (currentIndex > -1) { const newLine = currentLine.replace(options[currentIndex], nextOption); fountainInput.setRangeText(newLine, lineStart, lineEnd > -1 ? lineEnd : value.length); } else { document.execCommand('insertText', false, nextOption); }
            }

            function openProjectInfoModal() { const info = projectData.projectInfo || {}; document.getElementById('project-info-modal').classList.add('open'); document.getElementById('prod-name-input').value = info.prodName || ''; document.getElementById('director-name-input').value = info.directorName || ''; }
            function handleSaveProjectInfo() { projectData.projectInfo.prodName = document.getElementById('prod-name-input').value; projectData.projectInfo.directorName = document.getElementById('director-name-input').value; projectData.projectInfo.projectName = projectData.projectInfo.prodName || "Untitled"; saveProjectData(); document.getElementById('project-info-modal').classList.remove('open'); }
            function openTitlePageModal() { document.getElementById('title-page-modal').classList.add('open'); document.getElementById('title-input').value = projectData.projectInfo.projectName || ''; document.getElementById('author-input').value = projectData.projectInfo.prodName || ''; }
            function saveTitlePage() { projectData.projectInfo.projectName = document.getElementById('title-input').value || "Untitled"; projectData.projectInfo.prodName = document.getElementById('author-input').value || "Author"; saveProjectData(); document.getElementById('title-page-modal').classList.remove('open'); }
            
            function getFilteredScriptText() {
                const category = filterCategorySelect.value;
                const value = filterValueInput.value.toLowerCase().trim();
                if (category === 'all' || !value) return fountainInput.value;

                const output = fountain.parse(fountainInput.value, true);
                const scenes = parseScriptToUniversalFormat(fountainInput.value, projectData.projectInfo).scenes;
                const filteredSceneNumbers = new Set();

                scenes.forEach(scene => {
                    if (category === 'sceneSetting' && scene.sceneSetting.toLowerCase().includes(value)) filteredSceneNumbers.add(scene.sceneNumber);
                    else if (category === 'sceneType' && scene.sceneType.toLowerCase().replace(/\./g, '') === value.replace(/\./g, '')) filteredSceneNumbers.add(scene.sceneNumber);
                    else if (category === 'cast' && scene.breakdownData.cast.some(c => c.name.toLowerCase().includes(value))) filteredSceneNumbers.add(scene.sceneNumber);
                });
                
                let finalScript = '';
                let sceneBlocks = fountainInput.value.split(/^(?=INT\.|EXT\.|INT\.\/EXT\.)/im);
                sceneBlocks.forEach(block => {
                    if (block.trim() === '') return;
                    const headingMatch = block.match(/^(INT\.?\/EXT\.?|INT\.|EXT\.).*/i);
                    if(headingMatch) {
                        const heading = headingMatch[0];
                        const sceneNum = fountain.parse(heading, true).tokens[0].scene_number;
                        if(filteredSceneNumbers.has(sceneNum.toString())) {
                            finalScript += block;
                        }
                    } else {
                         // This catches title page content before the first scene
                        if (resultLines.length === 0 && sceneCounter === 0) {
                            finalScript += block;
                        }
                    }
                });
                return finalScript || "No scenes match your filter.";
            }
            
            function handleFilterChange() { filterValueInput.style.display = filterCategorySelect.value === 'all' ? 'none' : 'block'; filterValueInput.value = ''; applyFilter(); }
            function applyFilter() { if (currentView === 'script') renderScript(); if (currentView === 'card') renderCardView(); }
            async function shareSceneCardAsImage(cardElement) { if(!cardElement) return; try { const canvas = await html2canvas(cardElement, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--surface-color') }); const fileName = `Scene_${cardElement.dataset.sceneNumber}.png`; canvas.toBlob((blob) => { if(navigator.share) { const file = new File([blob], fileName, {type: 'image/png'}); navigator.share({title: `Scene #${cardElement.dataset.sceneNumber}`, files: [file]}).catch(console.error); } else { const link = document.createElement('a'); link.download = fileName; link.href = URL.createObjectURL(blob); link.click(); URL.revokeObjectURL(link.href); } }, 'image/png'); } catch (err) { console.error("Failed to share scene card:", err); alert("Could not generate shareable image."); } }
            function editSceneFromCard(sceneId) { const scenes = parseScriptToUniversalFormat(fountainInput.value, projectData.projectInfo).scenes; const sceneToFind = scenes.find(s => s.sceneId === sceneId); if(!sceneToFind) return; const textToFind = `${sceneToFind.sceneType}. ${sceneToFind.sceneSetting} - ${sceneToFind.dayNight}`; const index = fountainInput.value.toUpperCase().indexOf(textToFind); if(index > -1) { switchView('write'); fountainInput.focus(); fountainInput.setSelectionRange(index, index); fountainInput.scrollTop = fountainInput.scrollHeight * (index / fountainInput.value.length); } else { alert("Could not find the scene in the editor. It may have been changed."); } }
            
            function createModalHTML(id, title, body, footer) { const modal = document.getElementById(id); modal.innerHTML = `<div class="modal-content"><button class="modal-close-btn icon-btn" style="position: absolute; top: 0.5rem; right: 0.5rem;">&times;</button><div class="modal-header"><h2>${title}</h2></div><div class="modal-body">${body}</div><div class="modal-footer">${footer}</div></div>`; }
            createModalHTML('project-info-modal', 'Project Info', `<div class="form-group"><label for="prod-name-input">Production Name / Title</label><input type="text" id="prod-name-input"></div><div class="form-group"><label for="director-name-input">Author / Writer</label><input type="text" id="director-name-input"></div>`, `<button id="save-project-info-btn" class="main-action-btn">Save</button>`);
            createModalHTML('about-modal', 'About ToscripT', `<p style="text-align: center;">Designed by Thosho Tech</p>`, '');
            createModalHTML('info-modal', 'Info & Help', `<h3>Fountain Syntax</h3><ul><li><strong>Scene Heading:</strong> Line starts with INT. or EXT.</li><li><strong>Character:</strong> Any line in all uppercase.</li><li><strong>Dialogue:</strong> Text following a Character.</li></ul><h3>Button Guide</h3><ul><li><strong>Aa:</strong> Toggles current line to UPPERCASE.</li><li><strong>():</strong> Wraps selected text in parentheses.</li></ul>`, '');
            createModalHTML('title-page-modal', 'Title Page', `<div class="form-group"><label for="title-input">Title</label><input type="text" id="title-input"></div><div class="form-group"><label for="author-input">Author</label><input type="text" id="author-input"></div>`, `<button id="save-title-btn" class="main-action-btn">Save</button>`);
            
            async function shareScript() { if (navigator.share) { try { await navigator.share({ title: projectData.projectInfo.projectName, text: fountainInput.value }); } catch(err) { console.error("Share failed", err); } } else { alert('Sharing is not supported on this browser.'); } }
            function toggleSceneNumbers() { showSceneNumbers = !showSceneNumbers; updateSceneNoIndicator(); saveProjectData(); if (scriptView.classList.contains('active')) { renderScript(); } }
            function updateSceneNoIndicator() { const indicator = document.getElementById('scene-no-indicator'); if (showSceneNumbers) { indicator.classList.add('on'); indicator.classList.remove('off'); } else { indicator.classList.add('off'); indicator.classList.remove('on'); } }
            function toggleAutoSave() { const indicator = document.getElementById('auto-save-indicator'); if (autoSaveInterval) { clearInterval(autoSaveInterval); autoSaveInterval = null; indicator.classList.add('off'); indicator.classList.remove('on'); alert('Auto-save disabled.'); } else { autoSaveInterval = setInterval(saveProjectData, 120000); indicator.classList.add('on'); indicator.classList.remove('off'); alert('Auto-save enabled (every 2 minutes).'); } }
            function updateSceneNavigator() { const output = fountain.parse(fountainInput.value); sceneList.innerHTML = output.tokens.filter(t => t.type === 'scene_heading').map((token) => `<li data-line="${token.line}">${token.text}</li>`).join(''); new Sortable(sceneList, { animation: 150, ghostClass: 'dragging', onEnd: (evt) => { /* Reordering logic can be enhanced here */ } }); }
            
            // --- THIS IS THE FIX ---
           setupEventListeners();
loadProjectData();
setPlaceholder();
history.updateButtons();
        });
    </script>
</body>
</html>

